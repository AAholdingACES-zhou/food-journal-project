# 美食手帐网页 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 产品定位
一款基于Web的美食手帐生成工具，通过AI技术帮助用户将美食照片转换为精美的手绘风格手帐页面。

### 1.2 目标用户
- 美食爱好者
- 喜欢记录生活的用户
- 社交媒体内容创作者
- 手帐爱好者

### 1.3 核心价值
- 快速将普通美食照片转换为精美手帐
- AI智能处理，降低用户操作门槛
- 支持个性化定制与本地导出（PNG/PDF）

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 图片上传与处理 ✅ **已完成**
- **功能描述**：用户上传美食图片
- **实现状态**：✅ 已实现
- **技术要求**：
  - ✅ 支持拖拽上传和点击上传（`ImageUploader`组件）
  - ✅ 支持常见图片格式（JPG, PNG, WebP等）
  - ✅ 图片大小限制：单张不超过5MB
  - ✅ 支持多张图片批量上传（最多10张）
- **AI抠图功能**：
  - ✅ 自动识别美食主体（Remove.bg API）
  - ✅ 移除背景和多余部分
  - ✅ 保留美食主体，支持边缘优化
  - ✅ 服务端API调用，确保API密钥安全
  - ✅ 支持失败降级（可使用原图）

#### 2.1.2 手绘风格边框 ✅ **已完成**
- **功能描述**：在美食图片周围添加白色手绘感线条边框
- **实现状态**：✅ 已实现（`ContourBorderedImage`组件 + `contour-border.ts`）
- **技术要求**：
  - ✅ 使用Canvas API绘制不规则手绘线条
  - ✅ 线条粗细随机变化，模拟手绘效果
  - ✅ 边框颜色可配置（默认白色）
  - ✅ 支持轮廓检测，自动生成点线结合的边框
  - ✅ 可调节参数：轮廓距离（gapPx）、轮廓粗细（strokePx）
  - ✅ 支持进度显示和错误处理

#### 2.1.3 文字内容管理 ✅ **已完成**
- **功能描述**：添加手写体文字到手帐页面，主要记录食材信息和吃后感
- **实现状态**：✅ 已实现
- **文字内容要求**：
  - **必填内容**：
    - ✅ **食材列表**：列出制作该美食使用的主要食材及用量
      - ✅ 支持手绘bullet point（• 符号）
      - ✅ 格式示例："辣皮子 30g"、"洋葱 100g"、"Pasta 80g"
      - ✅ 多行输入支持（`IngredientsInput`组件）
    - ✅ **一句话吃后感**：简短描述品尝感受或评价
      - ✅ 示例："正宗 中国味!"、"Fresh!!!"、"冰箱剩啥吃啥"
  - **可选内容**：
    - ✅ **日期**：记录制作或品尝日期（格式：2025.01.07）
    - ✅ **标题**：美食名称（如："辣皮子炒Pasta"、"Damn 炒 Fai"）
    - ✅ **装饰性文字**：如"Feat. 某物"、"剩菜处理"等
- **功能点**：
  - **用户输入模式**：
    - ✅ 提供分类输入框（食材、吃后感、日期等）
    - ✅ 支持多行文本
    - ✅ 实时预览效果
  - **AI生成模式**：
    - ✅ 自动生成：标题、日期、吃后感（一句话，风格自然、口语化）
    - ✅ **固定格式输出**：AI生成时输出"日期 + 标题 + 吃后感"，食材列表由用户手动输入
    - ✅ 用户可编辑AI生成内容
    - ✅ 服务端调用DeepSeek API，支持中英文混合
- **手写体渲染**：
  - ✅ 使用手写体字体库（ELHandwritten字体）
  - ✅ 支持字体大小、颜色自定义
  - ✅ 文字位置可拖拽调整（`DraggableText`组件）
  - ✅ 支持手绘风格的装饰符号（bullet points）

#### 2.1.4 样式定制 ✅ **已完成**
- **功能描述**：用户自定义手帐外观
- **实现状态**：✅ 已实现
- **可配置项**：
  - ✅ **手帐底色**：默认黑色，支持多种颜色选择（颜色选择器）
  - ✅ **字体颜色**：默认白色，支持自定义（颜色选择器）
  - ✅ **边框颜色**：默认白色（在边框添加时配置）
- **重要**：默认配色方案为黑底白字，符合手帐风格

#### 2.1.5 智能排版与手动调整 ✅ **已完成**
- **功能描述**：AI自动排版多张美食图片，用户可手动调整
- **实现状态**：✅ 已实现（`auto-layout.ts` + `DraggableImage`/`DraggableText`组件）
- **AI自动排版规则**：
  - ✅ 每页手帐最多包含2张主要美食图片
  - ✅ 自动计算最佳布局：
    - ✅ 左右布局：图片在左，文字在右（或相反）
    - ✅ 上下布局：图片在上，文字在下（或相反）
    - ✅ 自由布局：根据图片尺寸和内容灵活安排
  - ✅ 文字与图片的合理搭配：
    - ✅ 食材列表紧邻对应美食图片
    - ✅ 吃后感可放置在图片附近或页面角落
    - ✅ 日期通常放置在页面左上角或右上角
  - ✅ 保持整体美观和平衡
- **手动排版调整**：
  - ✅ **拖拽功能**：用户可拖拽图片和文字元素到任意位置
  - ✅ **缩放功能**：支持调整图片和文字大小（滑块控制）
  - ✅ **旋转功能**：支持轻微旋转元素（模拟手绘不规整感，-180°到180°）
  - ✅ **实时预览**：调整时实时显示效果
- **分页逻辑**：
  - ✅ 超过2张主要图片时自动分页
  - ✅ 支持多页手帐生成（页面切换按钮）
  - ✅ 每页独立编辑和调整

#### 2.1.6 导出功能 ✅ **已完成**
- **功能描述**：保存生成的手帐到本地
- **实现状态**：✅ 已实现（`ExportDialog`组件）
- **导出功能**：
  - ✅ 导出为PNG图片（高清，支持自定义分辨率，1x/2x/3x）
  - ✅ 导出为PDF（多页支持，使用jsPDF）
  - ✅ 支持自定义导出质量（缩放比例）
  - ✅ 多页导出时自动命名（"美食手帐-第X页.png"）
  - ✅ 导出进度显示

### 2.2 辅助功能

#### 2.2.1 图片编辑 ✅ **已完成**
- ✅ 图片旋转、缩放（在编辑页面的属性面板）
- ⚠️ 图片裁剪（自由裁剪/比例裁剪）- **未实现**
- ✅ 手动擦除（橡皮擦工具，`ImageEditor`组件）
  - ✅ 支持撤销/重做功能（历史记录管理）
  - ✅ 可调节画笔大小（5-50px）
  - ✅ 棋盘格背景显示透明区域
  - ✅ 支持鼠标和触摸操作
- ⚠️ 亮度、对比度调整 - **未实现**
- ⚠️ 滤镜效果 - **未实现**

#### 2.2.2 预览功能 ✅ **已完成**
- ✅ 实时预览手帐效果（编辑页面中间区域）
- ✅ 支持多页预览（页面切换）
- ✅ 截图模式（隐藏UI，仅显示画布，方便截图）

#### 2.2.3 历史记录 ⚠️ **部分实现**
- ✅ 图片编辑历史记录（撤销/重做功能）
- ⚠️ 保存用户生成的手帐记录 - **未实现**
- ⚠️ 支持重新编辑历史手帐 - **未实现**
- ⚠️ 本地存储（使用LocalStorage或IndexedDB） - **未实现**

## 3. 技术方案

### 3.1 前后端技术栈（MVP）✅ **已实现**
- ✅ **框架**：Next.js 14+（App Router）
- ✅ **认证**：NextAuth.js（邮箱魔法链接）
- ✅ **UI库**：Tailwind CSS
- ✅ **图片处理**：Canvas API
- ✅ **字体**：Web Fonts（ELHandwritten手写体字体）
- ✅ **状态管理**：Zustand（`journal-store.ts`）
- ✅ **导出库**：html2canvas + jsPDF
- ✅ **部署**：支持Vercel部署

### 3.2 AI服务集成 ✅ **已实现**

#### 3.2.1 图片抠图服务 ✅ **已实现**
- ✅ **方案**：Remove.bg API（服务端调用）
- ✅ **实现位置**：`/api/remove-bg/route.ts`
- ✅ **安全措施**：API密钥存储在服务端环境变量，前端不暴露
- ✅ **错误处理**：支持失败降级，可使用原图

#### 3.2.2 文字生成服务 ✅ **已实现**
- ✅ **MVP范围**：仅生成标题、日期、吃后感
- ✅ **不包含**：食材识别（需Vision/多模态能力，成本高且易误判）
- ✅ **方案**：DeepSeek API（服务端调用）
- ✅ **实现位置**：`/api/generate-text/route.ts`
- ✅ **生成格式要求**：
  - ✅ 必须包含：日期、标题、吃后感
  - ✅ 日期：格式"2025.01.07"（自动生成当前日期）
  - ✅ 标题：可参考用户手动输入的食材列表生成美食名称（但不新增食材）
  - ✅ 吃后感：一句话，自然口语化，带情感色彩
  - ✅ 支持中英文混合

### 3.3 访问控制与安全 ✅ **已实现**
- ✅ **认证方案**：NextAuth.js + 邮箱魔法链接（Magic Link）
- ✅ **白名单机制**：
  - ✅ 环境变量配置允许的邮箱列表（`ALLOWED_EMAILS`）
  - ✅ 用户输入邮箱后，系统校验是否在白名单
  - ✅ 仅白名单邮箱可完成登录
  - ✅ 实现位置：`/api/auth/[...nextauth]/route.ts`
- ✅ **API安全**：
  - ✅ 所有AI调用（抠图、文字生成）走 Next.js API Routes
  - ✅ API密钥存储在服务端环境变量
  - ✅ 前端不暴露任何API密钥
  - ✅ 所有API路由需要身份验证（`requireAuth`）
- ✅ **会话管理**：
  - ✅ Cookie/JWT（由 NextAuth 管理）
  - ✅ 会话有效期（24小时）
  - ✅ 使用Prisma适配器存储会话

### 3.4 手写体实现 ✅ **已实现**
- ✅ **方案**：使用手写体字体文件（ELHandwritten）
- ✅ **字体文件位置**：`/public/fonts/EL-Bold.ttf`, `EL-Regular.ttf`
- ✅ **CSS配置**：在`globals.css`中定义字体族

### 3.5 手绘线条实现 ✅ **已实现**
- ✅ 使用Canvas API绘制不规则线条（`contour-border.ts`）
- ✅ 使用轮廓检测算法（`image-contour.ts`）
- ✅ 线条粗细和透明度随机变化
- ✅ 支持点线结合的边框样式
- ✅ 线条边缘可添加轻微抖动，增强手绘感

### 3.6 排版算法与交互 ✅ **已实现**
- ✅ **自动排版算法**：
  - ✅ 基于图片尺寸和数量计算最佳布局（`auto-layout.ts`）
  - ✅ 使用绝对定位布局
  - ✅ 考虑黄金比例等设计原则
  - ✅ 文字与图片的视觉平衡
- ✅ **手动调整交互**：
  - ✅ 使用原生拖拽实现（`DraggableImage`、`DraggableText`组件）
  - ✅ 支持元素选择、移动、缩放、旋转
  - ✅ 保持手绘自由感，不过度约束

### 3.7 导出功能 ✅ **已实现**
- ✅ 使用html2canvas将DOM转换为图片
- ✅ 使用jsPDF生成PDF文件
- ✅ 支持高分辨率导出（1x/2x/3x缩放）
- ✅ 多页支持

## 4. 页面结构 ✅ **已实现**

### 4.1 主要页面
0. ✅ **登录页**（`/login`）
   - ✅ 邮箱输入框
   - ✅ 发送魔法链接按钮
   - ✅ 白名单校验提示

1. ✅ **首页**（`/`）
   - ✅ 欢迎页面，引导用户登录或上传

2. ✅ **上传页**（`/upload`）
   - ✅ 图片上传区域（拖拽和点击）
   - ✅ 操作指引
   - ✅ 图片预览和处理进度显示
   - ✅ 自动AI抠图处理

3. ✅ **编辑页**（`/edit`）
   - ✅ 左侧：工具栏（样式设置、文字输入、AI生成等）
   - ✅ 中间：手帐预览区域（可拖拽调整元素位置）
   - ✅ 右侧：属性面板（图片编辑、文字编辑、排版调整等）
   - ✅ 顶部：操作栏（返回、页面切换、截图模式、导出等）

### 4.2 组件设计 ✅ **已实现**
- ✅ `ImageUploader`：图片上传组件
- ✅ `ImageEditor`：图片编辑组件（支持擦除、撤销/重做）
- ✅ `CanvasEditor`：画布编辑器组件（整合图片编辑、边框添加等功能）
- ✅ `TextEditor`：文字编辑组件（分类输入：食材、吃后感、日期等）
- ✅ `IngredientsInput`：食材列表输入组件
- ✅ `ContourBorderedImage`：手绘边框图片组件
- ✅ `DraggableImage`：可拖拽图片组件（支持拖拽、缩放、旋转）
- ✅ `DraggableText`：可拖拽文字组件
- ✅ `CanvasContainer`：画布容器组件
- ✅ `ExportDialog`：导出对话框
- ✅ `ResizablePanel`：可调整大小的侧边栏面板

## 5. 用户体验设计 ✅ **已实现**

### 5.1 交互流程 ✅ **已实现**
1. ✅ 用户登录（邮箱魔法链接）
2. ✅ 用户上传美食图片（支持多张）
3. ✅ 自动进行AI抠图处理（显示加载状态和进度）
4. ✅ 用户手动输入食材列表；AI可生成标题、日期、吃后感（可编辑）
5. ✅ 自动排版布局（每页最多2张主要图片）
6. ✅ 用户可手动调整排版（拖拽、缩放、旋转元素）
7. ✅ 实时预览效果
8. ✅ 图片编辑（添加边框、擦除等）
9. ✅ 确认后生成最终手帐
10. ✅ 导出为PNG/PDF到本地

### 5.2 响应式设计 ⚠️ **部分实现**
- ⚠️ 支持桌面端（1920px+）- **已实现**
- ⚠️ 支持平板端（768px - 1920px）- **部分支持**
- ⚠️ 支持移动端（320px - 768px）- **未优化**

### 5.3 性能优化 ✅ **已实现**
- ✅ 图片压缩和懒加载
- ✅ 防抖和节流处理（拖拽操作）
- ✅ 状态管理优化（Zustand）

## 6. 技术难点与解决方案 ✅ **已解决**

### 6.1 AI抠图精度 ✅ **已解决**
- ✅ **方案**：使用Remove.bg API，提供失败降级方案（可使用原图）

### 6.2 手绘线条自然度 ✅ **已解决**
- ✅ **方案**：使用轮廓检测算法 + Canvas绘制随机曲线，实现点线结合的边框效果

### 6.3 多图片排版 ✅ **已解决**
- ✅ **方案**：
  - ✅ 实现自动排版算法（`auto-layout.ts`）
  - ✅ 使用原生拖拽实现灵活的手动调整
  - ✅ 保持手绘自由感，不过度约束用户操作

### 6.4 手写体渲染 ✅ **已解决**
- ✅ **方案**：使用ELHandwritten字体文件，通过CSS加载

### 6.5 导出图片质量 ✅ **已解决**
- ✅ **方案**：使用html2canvas高DPI渲染，支持1x/2x/3x缩放

### 6.6 图片编辑状态同步 ✅ **已解决**
- ✅ **方案**：统一图片源管理，确保擦除和添加边框功能使用相同的图片源
- ✅ 保存后状态同步更新，确保后续操作使用最新图片

## 7. 开发计划

### 7.1 MVP版本 ✅ **已完成**

#### ✅ 访问控制
- ✅ 邮箱魔法链接登录（NextAuth.js）
- ✅ 白名单校验（环境变量配置）
- ✅ 会话管理（JWT，24小时）

#### ✅ 基础图片上传
- ✅ 拖拽和点击上传（单张≤5MB）
- ✅ 支持多张批量上传（最多10张）
- ✅ 文件格式验证（JPG、PNG、WebP）

#### ✅ AI抠图集成
- ✅ Remove.bg API（服务端调用）
- ✅ 进度显示和错误处理
- ✅ 失败降级方案

#### ✅ 图片编辑功能
- ✅ 旋转、缩放（属性面板）
- ⚠️ 裁剪（自由/比例）- **未实现**
- ✅ 手动擦除（橡皮擦工具）
  - ✅ 支持撤销/重做
  - ✅ 可调节画笔大小
  - ✅ 棋盘格背景显示

#### ✅ 手绘风格边框
- ✅ 白色不规则线条（轮廓检测 + Canvas绘制）
- ✅ 可配置参数（距离、粗细）
- ✅ 进度显示和错误处理

#### ✅ 文字输入功能
- ✅ 食材列表输入（用户手动输入，支持bullet）
- ✅ 吃后感输入
- ✅ 日期输入
- ✅ 标题输入
- ✅ 自定义文本输入

#### ✅ 手写体字体渲染
- ✅ ELHandwritten字体加载和使用

#### ✅ 样式设置
- ✅ 黑底白字默认
- ✅ 背景色自定义
- ✅ 字体颜色自定义

#### ✅ AI文字生成
- ✅ 仅标题+日期+吃后感（服务端调用，DeepSeek）
- ✅ 用户可编辑AI生成内容

#### ✅ 自动排版
- ✅ 每页最多2张图片
- ✅ 智能布局算法

#### ✅ 手动排版调整
- ✅ 拖拽、缩放、旋转

#### ✅ 多页手帐生成
- ✅ 页面切换
- ✅ 每页独立编辑

#### ✅ 导出功能
- ✅ PNG高清导出（支持1x/2x/3x）
- ✅ PDF多页导出

## 8. 风险评估

### 8.1 技术风险 ✅ **已应对**
- ✅ **AI服务稳定性**：已实现错误处理和降级方案
- ✅ **浏览器兼容性**：使用现代浏览器API，已测试

### 8.2 成本风险 ⚠️ **需关注**
- ⚠️ **API调用费用**：Remove.bg和DeepSeek API可能产生费用
  - ⚠️ **应对**：需要监控API调用频率和成本

### 8.3 用户体验风险 ✅ **已优化**
- ✅ **处理速度**：已优化加载体验，提供进度提示

## 9. 后续优化方向

1. ⚠️ **作品管理**：更完善的历史记录与作品管理（本地存储）
2. ⚠️ **模板系统**：提供多种手帐模板和布局样式
3. ⚠️ **响应式优化**：优化移动端浏览器体验（保持网页应用）
4. ⚠️ **图片裁剪功能**：实现自由裁剪和比例裁剪
5. ⚠️ **装饰元素库**：提供更多手绘装饰元素（箭头、心形、星星等）
6. ⚠️ **打印服务**：提供实体手帐打印服务
7. ⚠️ **多页管理优化**：优化多页手帐的编辑和管理体验

## 10. 成功指标

- ✅ 用户完成一次手帐生成的转化率 > 60%（待验证）
- ✅ 平均生成时间 < 30秒（已优化）
- ✅ 用户满意度 > 4.5/5.0（待验证）
- ✅ 导出率 > 30%（待验证）

---

## 附录

### A. 参考资源
- ✅ 手写体字体资源（ELHandwritten）
- ✅ AI服务API文档（Remove.bg、DeepSeek）
- ✅ Canvas绘图教程

### B. 术语表
- **抠图**：从图片中分离出主体对象
- **手绘感**：模拟手绘的不规则、自然效果
- **排版**：图片和文字的布局安排

---

**文档版本**：v3.0  
**创建日期**：2025年1月7日  
**最后更新**：2025年1月7日

## 更新日志

### v3.0 (2025-01-07) - MVP完成版
- ✅ **更新开发状态**：标记所有已完成功能
- ✅ **补充实现细节**：添加技术实现说明和组件信息
- ✅ **更新技术方案**：记录实际使用的技术栈和库
- ✅ **完善功能描述**：补充实际实现的功能特性
- ✅ **标记未实现功能**：明确标注未实现的功能（裁剪、历史记录等）

### v2.0 (2025-01-07) - MVP简化版
- **移除AI食材识别**：食材列表改为用户手动输入
- **移除分享功能**：MVP仅支持本地导出PNG/PDF
- **新增访问控制**：邮箱魔法链接 + 白名单机制；AI调用全部走服务端
- **新增图片编辑**：裁剪、手动擦除
- **调整图片限制**：单张从10MB改为5MB
- **移除响应式预览**：简化预览功能
- **删除完整版本规划**：专注MVP开发
- **明确技术栈**：Next.js + NextAuth.js + Remove.bg
